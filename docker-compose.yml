version: "3.9"

services:
  # Your existing environment for training/eval via main.py
  clarity-cli:
    build:
      context: .
      dockerfile: deploy/Dockerfile
    container_name: clarity-cli
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: [gpu]
    volumes:
      - .:/app
      - ./models:/models
    entrypoint: ["python", "main.py"]
    environment:
      PYTHONUNBUFFERED: "1"
      PYTHONDONTWRITEBYTECODE: "1"
    stdin_open: true
    tty: true

  # The new FastAPI deployment
  clarity-api:
    build:
      context: .
      dockerfile: deploy/Dockerfile.api
    container_name: clarity-api
    ports:
      - "8000:8000"
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: [gpu]
    volumes:
      - .:/app
      - ./models:/models
    # Overrides the Dockerfile CMD to enable hot-reloading for development
    command: ["uvicorn", "api.main:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]
    environment:
      PYTHONUNBUFFERED: "1"
      PYTHONDONTWRITEBYTECODE: "1"

  # The new Frontend UI
  clarity-frontend:
    build:
      context: .
      dockerfile: deploy/Dockerfile.frontend
    container_name: clarity-frontend
    ports:
      - "3000:3000" # Changed to 3000 to match typical Next.js dev/prod defaults
    depends_on:
      - clarity-api
    environment:
      - NEXT_PUBLIC_API_URL=http://localhost:8000